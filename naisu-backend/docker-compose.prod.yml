# =============================================================================
# Naisu Backend - Production Docker Compose
# Uses pre-built image from Docker Hub
# For CI/CD auto-deployment
# =============================================================================

version: '3.8'

services:
  api:
    image: ${DOCKER_USERNAME:-naisu}/naisu-backend:latest
    container_name: naisu-backend-api
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Server
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0
      
      # Database
      DATABASE_URL: ${DATABASE_URL:-}
      
      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # EVM Configuration
      BASE_SEPOLIA_RPC: ${BASE_SEPOLIA_RPC:-https://sepolia.base.org}
      BASE_SEPOLIA_CHAIN_ID: ${BASE_SEPOLIA_CHAIN_ID:-84532}
      BASE_MAINNET_RPC: ${BASE_MAINNET_RPC:-https://mainnet.base.org}
      BASE_MAINNET_CHAIN_ID: ${BASE_MAINNET_CHAIN_ID:-8453}
      EVM_ADMIN_PRIVATE_KEY: ${EVM_ADMIN_PRIVATE_KEY:-}
      EVM_FALLBACK_RPC_URL: ${EVM_FALLBACK_RPC_URL:-}
      
      # Contracts
      NAISU_SWAP_CONTRACT: ${NAISU_SWAP_CONTRACT:-0xfaBD3bdeecf7f858d6cef1c137694e19Ac7187f6}
      NAISU_REWARDS_CONTRACT: ${NAISU_REWARDS_CONTRACT:-0xD24463BBde91Df1937F4CFC4F627fFc76728b8A6}
      POOL_MANAGER: ${POOL_MANAGER:-0x05E73354cFDd6745C338b50BcFDfA3Aa6fA03408}
      
      # Features
      ENABLE_UNISWAP_V4: ${ENABLE_UNISWAP_V4:-true}
      
      # Redis
      REDIS_URL: ${REDIS_URL:-}
      
      # Security
      API_KEY_HEADER: ${API_KEY_HEADER:-x-api-key}
    networks:
      - naisu-network
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3000/api/v1/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: PostgreSQL (comment out if using external DB)
  postgres:
    image: postgres:16-alpine
    container_name: naisu-backend-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-naisu}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-naisu_password}
      POSTGRES_DB: ${DB_NAME:-naisu_backend}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"  # Only bind to localhost for security
    networks:
      - naisu-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-naisu} -d ${DB_NAME:-naisu_backend}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

networks:
  naisu-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
