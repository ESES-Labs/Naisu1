# =============================================================================
# Naisu Backend - CD Workflow
# Auto-deploys to VPS when changes are pushed to main branch
# =============================================================================

name: Naisu Backend CD

on:
  push:
    branches: [main]
    paths:
      - 'naisu-backend/**'
      - '.github/workflows/naisu-backend*.yml'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: naisu-backend-deployment
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Build and Push Docker Image
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/naisu-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./naisu-backend
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Deploy to VPS
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # -----------------------------------------------------------------------
      # Deploy via SSH (Option 1: Direct SSH commands)
      # -----------------------------------------------------------------------
      - name: Deploy to VPS via SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/naisu-backend' }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "üöÄ Starting deployment to VPS..."
          
          # Create deployment script on VPS
          ssh $VPS_USER@$VPS_HOST << 'EOF'
            set -e
            
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            DOCKER_USERNAME="${{ env.DOCKER_USERNAME }}"
            
            echo "‚ûú Creating deployment directory..."
            sudo mkdir -p $DEPLOY_PATH
            sudo chown $USER:$USER $DEPLOY_PATH
            
            cd $DEPLOY_PATH
            
            echo "‚ûú Pulling latest Docker image..."
            docker pull $DOCKER_USERNAME/naisu-backend:latest
            
            echo "‚ûú Checking if docker-compose exists..."
            if [ -f "docker-compose.yml" ]; then
              echo "‚ûú Updating image in docker-compose..."
              sed -i "s|image:.*naisu-backend.*|image: $DOCKER_USERNAME/naisu-backend:latest|" docker-compose.yml
              
              echo "‚ûú Restarting services..."
              docker-compose down
              docker-compose up -d
            else
              echo "‚ö† docker-compose.yml not found. Running container directly..."
              docker stop naisu-backend 2>/dev/null || true
              docker rm naisu-backend 2>/dev/null || true
              docker run -d \
                --name naisu-backend \
                --restart unless-stopped \
                -p 3000:3000 \
                --env-file .env \
                $DOCKER_USERNAME/naisu-backend:latest
            fi
            
            echo "‚ûú Cleaning up old images..."
            docker image prune -f
            
            echo "‚úì Deployment complete!"
            
            echo "‚ûú Checking health..."
            sleep 5
            curl -f http://localhost:3000/api/v1/health || exit 1
            echo "‚úì Health check passed!"
          EOF

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê API URL: http://${{ secrets.VPS_HOST }}:3000"
          echo "üìä Health: http://${{ secrets.VPS_HOST }}:3000/api/v1/health"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          exit 1

  # ---------------------------------------------------------------------------
  # Deploy via Webhook (Option 2 - Alternative approach)
  # ---------------------------------------------------------------------------
  # Uncomment this and comment out the SSH deploy job above if using webhook
  # deploy-webhook:
  #   name: Trigger Webhook Deploy
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   steps:
  #     - name: Trigger deployment webhook
  #       run: |
  #         curl -X POST \
  #           -H "Authorization: Bearer ${{ secrets.DEPLOY_WEBHOOK_TOKEN }}" \
  #           -H "Content-Type: application/json" \
  #           -d '{"image": "${{ secrets.DOCKER_USERNAME }}/naisu-backend:latest"}' \
  #           ${{ secrets.DEPLOY_WEBHOOK_URL }}
